<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@0.7.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
      #boxes-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
      }
      .box {
        width: 300px;
        margin: 10px;
        border: 1px solid black;
        align-items: center;
        justify-content: center;
      }
      .editable {
        cursor: text;
      }
      textarea {
        display: none;
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <button id="add-box-btn">Add Box</button>
    <div id="boxes-container"></div>

    <script>
      let boxes = [];

      $("#add-box-btn").click(function () {
        let box = {
          id: boxes.length,
          content: "Click to Edit",
        };
        boxes.push(box);
        addBox(box);
      });

      function addBox(box) {
        let boxEl = $(`
          <div class="box" id="box-${box.id}">
            ${marked(box.content)}
          </div>
        `);
        boxEl.click(function () {
          let textarea = $(`<textarea>${box.content}</textarea>`);
          textarea.blur(function () {
            box.content = textarea.val();
            renderBox(box);
          });
          $(this).html(textarea);
          textarea.show();
          textarea.focus();
          textarea[0].setSelectionRange(textarea[0].value.length, textarea[0].value.length);
        });
        $("#boxes-container").append(boxEl);
      }

      function renderBox(box) {
        let boxEl = $(`#box-${box.id}`);
        let content = marked(box.content).replace(/\$\$(.+?)\$\$/g, '$$$1$$');
        boxEl.html(content);
        MathJax.typeset();
        let newHeight = boxEl.height();
        boxEl.height(newHeight);
      }
    </script>
  </body>
</html>

