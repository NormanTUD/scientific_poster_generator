<!DOCTYPE html>
<html>
        <head>
                <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
                <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
		<style>
			.textbox {
				border: 1px solid red;
				padding: 10px;
			}
		</style>
        </head>
        <body>
		<div id="textboxes">
			<div class="textbox"></div>
			<div class="textbox"></div>
		</div>

                <script>
			var textBoxes = $(".textbox");

			for (var i = 0; i < textBoxes.length; i++) {
				var textBox = textBoxes[i];
				let isEditing = false;

				textBox.innerText = "# hallo\n\n- a\n- b\n- c\n\n$$ \\frac{a}{b} $$\n\n ## h2\nbla"
				let originalContent = textBox.innerText;

				function render () {
						var content = textBox.innerText;
						originalContent = content;
						var renderedContent = marked.marked(content);
						textBox.innerHTML = renderedContent;
						MathJax.typeset([textBox]);

						textBox.contentEditable = false;
						textBox.style.backgroundColor = "transparent";
						isEditing = false;
				}

				textBox.addEventListener("dblclick", function() {
					if (!isEditing) {
						textBox.innerText = originalContent;
						this.contentEditable = true;
						this.style.backgroundColor = "lightgreen";
						isEditing = true;
					} else {
						textBox.contentEditable = false;
						textBox.style.backgroundColor = "transparent";
						isEditing = false;
					}
				});

				document.addEventListener("click", function(event) {
					if (isEditing && event.target !== textBox) {
						render();
					}
				});

				textBox.addEventListener("dragover", function(event) {
					event.preventDefault();
				});

				textBox.addEventListener("drop", function(event) {
					event.preventDefault();
					var file = event.dataTransfer.files[0];

					var formData = new FormData();
					formData.append("image", file);

					var xhr = new XMLHttpRequest();
					xhr.open("POST", "upload.php", true);
					xhr.onload = function() {
						if (xhr.status === 200) {
							var response = JSON.parse(xhr.responseText);
							//textBox.innerHTML += `<img src="${response.filePath}" />`;
							textBox.innerHTML += `![](${response.filePath})`
						} else {
							alert("An error occurred while uploading the file.");
						}
					};
					xhr.send(formData);
				});
			}

			render();
                </script>
        </body>
</html>

