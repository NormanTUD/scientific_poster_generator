<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" />
		<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
		<style>
.container {
	display: flex;
	flex-wrap: wrap;
}

    .container .box {
	    width: calc(33.33% - 20px);
	    height: 200px;
	    background-color: lightgray;
	    margin: 10px;
	    border: 1px solid gray;
	    display: flex;
	    align-items: center;
	    justify-content: center;
    }

    .container .box textarea {
	    width: 100%;
	    height: 100%;
	    border: none;
	    resize: none;
    }
		</style>
	</head>

	<body>
		<div class="container">
			<div class="box">
				<div class="content">
					Default text
				</div>
			</div>
		</div>

		<button id="addNewBox">Add New Box</button>

		<script src="https://cdn.jsdelivr.net/npm/showdown@1.9.1/dist/showdown.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
		<script>
			let activeBox = null;
			document.addEventListener("click", function (e) {
				if (!e.target.closest(".box")) {
					if (activeBox) {
						let markdown = activeBox.querySelector("textarea").value;
						let converter = new showdown.Converter();
						let html = converter.makeHtml(markdown);
						activeBox.querySelector(".content").innerHTML = html;
						MathJax.Hub.Queue(["Typeset", MathJax.Hub, activeBox]);
						activeBox.querySelector(".content").style.display = "flex";
						activeBox = null;
					}
				}
			});
			document.querySelectorAll(".box").forEach(function (box) {
				box.addEventListener("click", function () {
					let activeBox = document.querySelector(".box.active");
					if (activeBox) {
						activeBox.querySelector(".content").innerHTML = activeBox.querySelector("textarea").value;
						activeBox.classList.remove("active");
					}
					this.classList.add("active");
					let text = this.querySelector(".content").innerHTML;
					this.querySelector(".content").innerHTML = `<textarea>${text}</textarea>`;
					this.querySelector("textarea").focus();
				});
			});

			document.addEventListener("click", function (event) {
				if (!event.target.closest(".box")) {
					let activeBox = document.querySelector(".box.active");
					if (activeBox) {
						activeBox.querySelector("textarea").style.display = "none";
						let markdown = activeBox.querySelector("textarea").value;
						let html = marked.marked(markdown);
						html = html.replace(/\$\$(.*?)\$\$/g, function (match, p1) {
							return `<div class="math">\`\`\`math\n${p1}\n\`\`\`</div>`;
						});
						activeBox.querySelector(".content").innerHTML = html;
						activeBox.classList.remove("active");
						MathJax.Hub.Queue(["Typeset", MathJax.Hub, activeBox]);
					}
				}
			});

			document.querySelectorAll(".box").forEach(function (box) {
				box.querySelector(".content").addEventListener("drop", function (event) {
					event.preventDefault();
					let file = event.dataTransfer.files[0];
					let formData = new FormData();
					formData.append("file", file);
					axios.post("upload.php", formData).then(function (response) {
						let activeBox = document.querySelector(".box.active");
						if (activeBox) {
							let markdown = activeBox.querySelector("textarea").value;
							markdown += `\n![${file.name}](${response.data})`;
							activeBox.querySelector("textarea").value = markdown;
						}
					});
				});
			});
		</script>
	</body>
</html>
