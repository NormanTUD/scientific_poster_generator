<!DOCTYPE html>
<html>
	<head>
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
		<style>
.grid {
	display: grid;
	grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
	grid-gap: 20px;
}
      .box {
	      border: 1px solid black;
	      padding: 10px;
	      background-color: white;
	      min-height: 200px;
	      display: flex;
	      flex-direction: column;
	      justify-content: center;
      }
      textarea {
	      width: 100%;
	      height: 200px;
	      resize: none;
      }
		</style>
	</head>
	<body>
		<button id="add-box">Add Box</button>
		<div class="grid">
		</div>
		<script>
			function log (...args) {
				console.log(args);
			}

			function uuidv4() {
				return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
					(c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
				);
			}

			var markdowns = {};

			$(document).ready(function() {
				$("#add-box").click(function() {
					let box = `
	    <div class="box">
	      <div contenteditable="true">Click here to edit</div>
	    </div>
	  `;
					$(".grid").append(box);
				});
				$(document).on("click", ".box div", function() {
					let uuid = $(this).prop("id");
					var html = markdowns[uuid];
					$(this).replaceWith(`<textarea>${html}</textarea>`);
				});


				$(document).on("drop", "textarea", function(event) {
					event.preventDefault();
					var file = event.dataTransfer.files[0];

					var formData = new FormData();
					formData.append("image", file);

					var xhr = new XMLHttpRequest();
					xhr.open("POST", "upload.php", true);
					xhr.onload = function() {
						if (xhr.status === 200) {
							var response = JSON.parse(xhr.responseText);
							//textBox.innerHTML += `<img src="${response.filePath}" />`;
							textBox.innerHTML += `![](${response.filePath})`
						} else {
							alert("An error occurred while uploading the file.");
						}
					};
					xhr.send(formData);
				});


				document.addEventListener("click", function(event) {
					if (isEditing && event.target !== textBox) {
						var uuid = uuidv4();
						let markdown = $(this).val();
						markdowns[uuid] = markdown;
						let html = marked.marked(markdown);
						$(this).replaceWith(`<div id='${uuid}'>${html}</div>`);
						MathJax.typeset();
					}
				});
			});
		</script>
	</body>
</html>

